# 脚本参数自定义功能使用说明

## 功能概述

脚本管理系统现已支持参数自定义功能。在创建或编辑脚本时，可以定义参数列表，执行脚本时系统会动态生成参数输入表单，并通过环境变量将参数传递给脚本。

## 主要特性

1. **参数配置**
   - 可动态添加/删除参数
   - 每个参数包含：参数名、描述、默认值、是否必填
   - JSON格式存储，方便扩展

2. **执行时输入**
   - 自动生成参数输入表单
   - 显示参数说明和默认值
   - 支持一键使用默认值

3. **环境变量传递**
   - Python和JavaScript脚本统一使用环境变量获取参数
   - 参数名即为环境变量名
   - 无需额外的命令行参数解析

## 使用方法

### 1. 创建/编辑脚本时配置参数

在脚本创建或编辑页面，找到"参数配置"部分：

1. 点击"添加参数"按钮
2. 填写参数信息：
   - **参数名**：环境变量名，如 `API_KEY`、`TIMEOUT`
   - **参数说明**：参数用途描述
   - **默认值**：可选，执行时的默认值
   - **必填**：勾选表示该参数必须提供

3. 可添加多个参数，点击删除按钮移除不需要的参数

### 2. 在脚本中获取参数

#### Python 脚本示例

```python
import os

# 获取参数（带默认值）
api_key = os.getenv('API_KEY', 'default_key')
timeout = os.getenv('TIMEOUT', '30')
debug_mode = os.getenv('DEBUG_MODE', 'false')

# 转换类型
timeout = int(timeout)
debug = debug_mode.lower() == 'true'

print(f"API Key: {api_key}")
print(f"Timeout: {timeout} seconds")
print(f"Debug Mode: {debug}")

# 使用参数
if debug:
    print("Debug information...")
```

#### JavaScript 脚本示例

```javascript
// 获取参数（带默认值）
const apiKey = process.env.API_KEY || 'default_key';
const timeout = process.env.TIMEOUT || '30';
const debugMode = process.env.DEBUG_MODE || 'false';

// 转换类型
const timeoutNum = parseInt(timeout);
const debug = debugMode.toLowerCase() === 'true';

console.log(`API Key: ${apiKey}`);
console.log(`Timeout: ${timeoutNum} seconds`);
console.log(`Debug Mode: ${debug}`);

// 使用参数
if (debug) {
    console.log("Debug information...");
}
```

### 3. 执行脚本时输入参数

1. 点击"执行"按钮
2. 在"脚本参数"部分填写参数值
3. 可点击"使用默认值"按钮快速填充默认值
4. 上传文件（如需要）
5. 点击"执行"

## 参数定义格式

参数以JSON数组格式存储在数据库中：

```json
[
  {
    "key": "API_KEY",
    "description": "API密钥，用于身份验证",
    "default_value": "",
    "required": true
  },
  {
    "key": "TIMEOUT",
    "description": "请求超时时间（秒）",
    "default_value": "30",
    "required": false
  },
  {
    "key": "DEBUG_MODE",
    "description": "是否开启调试模式",
    "default_value": "false",
    "required": false
  }
]
```

## 实际应用示例

### 示例1：API调用脚本

**参数配置：**
- `API_URL`：API地址
- `API_KEY`：API密钥
- `RETRY_COUNT`：重试次数，默认值：3

**Python脚本：**
```python
import os
import requests

api_url = os.getenv('API_URL')
api_key = os.getenv('API_KEY')
retry_count = int(os.getenv('RETRY_COUNT', '3'))

headers = {'Authorization': f'Bearer {api_key}'}

for i in range(retry_count):
    try:
        response = requests.get(api_url, headers=headers)
        print(f"Response: {response.json()}")
        break
    except Exception as e:
        print(f"Attempt {i+1} failed: {e}")
```

### 示例2：数据处理脚本

**参数配置：**
- `INPUT_FORMAT`：输入格式（csv/json），默认值：csv
- `OUTPUT_FORMAT`：输出格式（csv/json），默认值：json
- `FILTER_COLUMN`：过滤列名

**Python脚本：**
```python
import os
import pandas as pd
import json

input_format = os.getenv('INPUT_FORMAT', 'csv')
output_format = os.getenv('OUTPUT_FORMAT', 'json')
filter_column = os.getenv('FILTER_COLUMN')

# 读取数据
if input_format == 'csv':
    df = pd.read_csv('input.csv')
else:
    df = pd.read_json('input.json')

# 过滤数据
if filter_column:
    df = df[df[filter_column].notna()]

# 输出数据
if output_format == 'json':
    result = df.to_json(orient='records')
    print(result)
else:
    df.to_csv('output.csv', index=False)
    print("Data saved to output.csv")
```

## 数据库迁移

如果你是从旧版本升级，需要运行数据库迁移脚本：

```bash
cd backend
python3 migrations/add_parameters_field.py migrate
```

回滚迁移（如需要）：
```bash
python3 migrations/add_parameters_field.py rollback
```

## 注意事项

1. **参数名建议**
   - 使用大写字母和下划线，如：`API_KEY`、`MAX_RETRIES`
   - 避免使用系统保留的环境变量名

2. **安全性**
   - 敏感信息（如密码、密钥）不要设置默认值
   - 每次执行时手动输入敏感参数

3. **类型转换**
   - 环境变量都是字符串类型
   - 在脚本中需要手动转换为需要的类型（int、bool等）

4. **FILES环境变量**
   - 系统保留 `FILES` 环境变量用于传递上传的文件列表
   - 请勿使用此名称作为自定义参数

## 技术实现

### 后端

- **数据库字段**：`scripts.parameters`（TEXT类型，存储JSON）
- **环境变量传递**：`backend/services/executor.py:87-113`
- **API支持**：创建和更新脚本时自动处理 `parameters` 字段

### 前端

- **参数配置组件**：`frontend/src/components/ParameterConfig.vue`
- **参数输入组件**：`frontend/src/components/ExecutionParams.vue`
- **集成页面**：`frontend/src/views/Scripts.vue`

## 常见问题

**Q: 参数可以包含特殊字符吗？**
A: 参数值可以包含任何字符，但参数名建议只使用字母、数字和下划线。

**Q: 如何传递复杂的JSON对象？**
A: 可以将JSON字符串作为参数值传递，然后在脚本中使用 `json.loads()` 解析。

**Q: 是否支持文件路径作为参数？**
A: 支持，但建议使用相对路径，因为脚本在执行空间中运行。

**Q: 参数数量有限制吗？**
A: 理论上没有限制，但建议不超过20个参数，保持脚本简洁。
