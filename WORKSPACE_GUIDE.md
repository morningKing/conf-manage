# è„šæœ¬å·¥ä½œç›®å½•åŠŸèƒ½è¯´æ˜

## æ¦‚è¿° ğŸ¯

æ¯ä¸ªè„šæœ¬éƒ½æ‹¥æœ‰è‡ªå·±**ç‹¬ç«‹çš„å·¥ä½œç›®å½•**ï¼ˆWorkspaceï¼‰ï¼Œè„šæœ¬æ‰§è¡Œæ—¶åªèƒ½åœ¨è‡ªå·±çš„å·¥ä½œç›®å½•ä¸­è¿›è¡Œæ–‡ä»¶æ“ä½œã€‚è¿™æ ·è®¾è®¡æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

### ä¼˜åŠ¿ âœ¨

1. **éš”ç¦»æ€§**: ä¸åŒè„šæœ¬ä¹‹é—´å®Œå…¨éš”ç¦»ï¼Œäº’ä¸å½±å“
2. **å®‰å…¨æ€§**: è„šæœ¬æ— æ³•è®¿é—®ç³»ç»Ÿå…¶ä»–ç›®å½•ï¼Œæé«˜å®‰å…¨æ€§
3. **ä¾¿äºç®¡ç†**: æ¯ä¸ªè„šæœ¬çš„è¾“å…¥è¾“å‡ºæ–‡ä»¶éƒ½åœ¨å›ºå®šä½ç½®
4. **æ˜“äºæ¸…ç†**: åˆ é™¤è„šæœ¬æ—¶ï¼Œå¯ä»¥ä¸€å¹¶åˆ é™¤å…¶å·¥ä½œç›®å½•
5. **ç‰ˆæœ¬è¿½æº¯**: å¯ä»¥ä¿ç•™å†å²æ‰§è¡Œçš„æ–‡ä»¶ï¼Œä¾¿äºè°ƒè¯•

## ç›®å½•ç»“æ„ ğŸ“

```
conf-manage/
â”œâ”€â”€ workspaces/              # å·¥ä½œç›®å½•æ ¹ç›®å½•
â”‚   â”œâ”€â”€ script_1/           # è„šæœ¬1çš„å·¥ä½œç›®å½•
â”‚   â”‚   â”œâ”€â”€ script_xxx.py   # æ‰§è¡Œçš„è„šæœ¬æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ uploaded_file.txt  # ä¸Šä¼ çš„æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ output.txt      # è„šæœ¬ç”Ÿæˆçš„æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ script_2/           # è„šæœ¬2çš„å·¥ä½œç›®å½•
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ script_3/           # è„šæœ¬3çš„å·¥ä½œç›®å½•
â”‚       â””â”€â”€ ...
â”œâ”€â”€ data/
â”‚   â””â”€â”€ uploads/            # ä¸´æ—¶ä¸Šä¼ ç›®å½•
â””â”€â”€ logs/                   # æ—¥å¿—ç›®å½•
```

## å·¥ä½œæµç¨‹ ğŸ”„

### 1. åˆ›å»ºè„šæœ¬

å½“åˆ›å»ºæ–°è„šæœ¬æ—¶ï¼š
- ç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºç‹¬ç«‹å·¥ä½œç›®å½•: `workspaces/script_{id}/`
- ç›®å½•æƒé™: è„šæœ¬å¯è¯»å†™æ­¤ç›®å½•

**ç¤ºä¾‹**:
```
è„šæœ¬ID: 5
å·¥ä½œç›®å½•: /path/to/conf-manage/workspaces/script_5/
```

### 2. ä¸Šä¼ æ–‡ä»¶

å½“æ‰§è¡Œè„šæœ¬å¹¶ä¸Šä¼ æ–‡ä»¶æ—¶ï¼š
1. æ–‡ä»¶å…ˆä¸Šä¼ åˆ° `data/uploads/` ä¸´æ—¶ç›®å½•
2. **è‡ªåŠ¨å¤åˆ¶**åˆ°è„šæœ¬çš„å·¥ä½œç›®å½•
3. è„šæœ¬æ¥æ”¶çš„æ˜¯**æ–‡ä»¶å**ï¼ˆè€Œéå®Œæ•´è·¯å¾„ï¼‰
4. è„šæœ¬åœ¨å½“å‰å·¥ä½œç›®å½•ä¸­æ“ä½œè¿™äº›æ–‡ä»¶

**æµç¨‹å›¾**:
```
ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶
    â†“
ä¿å­˜åˆ° data/uploads/20231201_123456_file.txt
    â†“
å¤åˆ¶åˆ° workspaces/script_5/file.txt
    â†“
è„šæœ¬æ¥æ”¶å‚æ•°: --files '["file.txt"]'
    â†“
è„šæœ¬åœ¨å·¥ä½œç›®å½•ä¸­è¯»å–: open("file.txt")
```

### 3. è„šæœ¬æ‰§è¡Œ

æ‰§è¡Œæ—¶çš„è®¾ç½®ï¼š
- **å·¥ä½œç›®å½•**: `cwd=workspaces/script_{id}/`
- **è„šæœ¬æ–‡ä»¶**: ä¿å­˜åœ¨å·¥ä½œç›®å½•ä¸­
- **æ–‡ä»¶å‚æ•°**: ä¼ é€’ç›¸å¯¹æ–‡ä»¶åï¼ˆéç»å¯¹è·¯å¾„ï¼‰

**Python ç¤ºä¾‹**:
```python
import argparse
import json

parser = argparse.ArgumentParser()
parser.add_argument('--files', type=str)
args = parser.parse_args()

if args.files:
    file_names = json.loads(args.files)
    # file_names = ["file1.txt", "file2.csv"]

    for filename in file_names:
        # ç›´æ¥ä½¿ç”¨æ–‡ä»¶åï¼Œåœ¨å½“å‰å·¥ä½œç›®å½•ä¸­
        with open(filename, 'r') as f:
            content = f.read()
            print(f"è¯»å– {filename}: {len(content)} å­—èŠ‚")
```

**JavaScript ç¤ºä¾‹**:
```javascript
const fs = require('fs');

const filesJson = process.env.PARAM_FILES;
if (filesJson) {
    const fileNames = JSON.parse(filesJson);
    // fileNames = ["file1.txt", "file2.csv"]

    fileNames.forEach(filename => {
        // ç›´æ¥ä½¿ç”¨æ–‡ä»¶å
        const content = fs.readFileSync(filename, 'utf8');
        console.log(`è¯»å– ${filename}: ${content.length} å­—èŠ‚`);
    });
}
```

### 4. æ–‡ä»¶æ“ä½œ

è„šæœ¬å¯ä»¥åœ¨å·¥ä½œç›®å½•ä¸­ï¼š
- âœ… **è¯»å–**ä¸Šä¼ çš„æ–‡ä»¶
- âœ… **åˆ›å»º**æ–°æ–‡ä»¶
- âœ… **ä¿®æ”¹**æ–‡ä»¶
- âœ… **åˆ é™¤**æ–‡ä»¶
- âœ… **åˆ›å»º**å­ç›®å½•
- âŒ **æ— æ³•è®¿é—®**å…¶ä»–è„šæœ¬çš„å·¥ä½œç›®å½•
- âŒ **æ— æ³•è®¿é—®**ç³»ç»Ÿå…¶ä»–ç›®å½•

**ç¤ºä¾‹**:
```python
import os

# âœ… åœ¨å·¥ä½œç›®å½•ä¸­åˆ›å»ºæ–‡ä»¶
with open("output.txt", 'w') as f:
    f.write("å¤„ç†ç»“æœ")

# âœ… åˆ›å»ºå­ç›®å½•
os.makedirs("data", exist_ok=True)

# âœ… åœ¨å­ç›®å½•ä¸­åˆ›å»ºæ–‡ä»¶
with open("data/result.json", 'w') as f:
    f.write('{"status": "success"}')

# âœ… åˆ—å‡ºå·¥ä½œç›®å½•å†…å®¹
files = os.listdir(".")
print(f"å·¥ä½œç›®å½•æ–‡ä»¶: {files}")

# âœ… è·å–å½“å‰å·¥ä½œç›®å½•
cwd = os.getcwd()
print(f"å½“å‰ç›®å½•: {cwd}")
```

### 5. åˆ é™¤è„šæœ¬

åˆ é™¤è„šæœ¬æ—¶ï¼š
- è‡ªåŠ¨åˆ é™¤è„šæœ¬çš„å·¥ä½œç›®å½•
- åŒ…æ‹¬æ‰€æœ‰å†å²æ–‡ä»¶å’Œæ•°æ®
- é‡Šæ”¾ç£ç›˜ç©ºé—´

## é…ç½®è¯´æ˜ âš™ï¸

### Config ç±»

**ä½ç½®**: `backend/config.py`

```python
class Config:
    # å·¥ä½œç›®å½•æ ¹è·¯å¾„
    WORKSPACES_DIR = os.path.join(BASE_DIR, 'workspaces')

    @staticmethod
    def get_script_workspace(script_id):
        """è·å–è„šæœ¬çš„å·¥ä½œç›®å½•è·¯å¾„"""
        return os.path.join(Config.WORKSPACES_DIR, f'script_{script_id}')

    @staticmethod
    def ensure_script_workspace(script_id):
        """ç¡®ä¿è„šæœ¬å·¥ä½œç›®å½•å­˜åœ¨"""
        workspace_path = Config.get_script_workspace(script_id)
        os.makedirs(workspace_path, exist_ok=True)
        return workspace_path
```

## API å˜åŒ– ğŸ”§

### åˆ›å»ºè„šæœ¬

**ç«¯ç‚¹**: `POST /api/scripts`

**å˜åŒ–**:
- åˆ›å»ºè„šæœ¬åè‡ªåŠ¨åˆ›å»ºå·¥ä½œç›®å½•
- è¿”å›æˆåŠŸåï¼Œå·¥ä½œç›®å½•å·²å°±ç»ª

**ç¤ºä¾‹**:
```json
POST /api/scripts
{
  "name": "æ•°æ®å¤„ç†è„šæœ¬",
  "type": "python",
  "code": "print('Hello')"
}

// å“åº”
{
  "code": 0,
  "data": {
    "id": 5,
    "name": "æ•°æ®å¤„ç†è„šæœ¬",
    ...
  }
}

// è‡ªåŠ¨åˆ›å»º: workspaces/script_5/
```

### åˆ é™¤è„šæœ¬

**ç«¯ç‚¹**: `DELETE /api/scripts/{id}`

**å˜åŒ–**:
- åˆ é™¤è„šæœ¬çš„åŒæ—¶åˆ é™¤å·¥ä½œç›®å½•
- é€’å½’åˆ é™¤æ‰€æœ‰æ–‡ä»¶

### æ‰§è¡Œè„šæœ¬

**ç«¯ç‚¹**: `POST /api/scripts/{id}/execute`

**å˜åŒ–**:
- ä¸Šä¼ çš„æ–‡ä»¶å¤åˆ¶åˆ°å·¥ä½œç›®å½•
- è„šæœ¬åœ¨å·¥ä½œç›®å½•ä¸­æ‰§è¡Œ
- æ–‡ä»¶å‚æ•°ä½¿ç”¨ç›¸å¯¹è·¯å¾„

## å®ç°ç»†èŠ‚ ğŸ”

### Executor æ›´æ–°

**ä½ç½®**: `backend/services/executor.py`

**å…³é”®ä¿®æ”¹**:

1. **ç¡®ä¿å·¥ä½œç›®å½•å­˜åœ¨**:
```python
workspace_path = Config.ensure_script_workspace(script.id)
print(f"è„šæœ¬ {script.id} å·¥ä½œç›®å½•: {workspace_path}")
```

2. **å¤åˆ¶ä¸Šä¼ çš„æ–‡ä»¶**:
```python
for file_info in uploaded_files:
    source_path = file_info['path']
    dest_filename = file_info['original_name']
    dest_path = os.path.join(workspace_path, dest_filename)
    shutil.copy2(source_path, dest_path)
```

3. **åˆ›å»ºè„šæœ¬æ–‡ä»¶åœ¨å·¥ä½œç›®å½•**:
```python
script_filename = f'script_{execution_id}.py'
script_file = os.path.join(workspace_path, script_filename)
with open(script_file, 'w') as f:
    f.write(script.code)
```

4. **è®¾ç½®æ‰§è¡Œå·¥ä½œç›®å½•**:
```python
process = subprocess.Popen(
    cmd,
    stdout=log_f,
    stderr=subprocess.STDOUT,
    cwd=workspace_path  # å…³é”®ï¼šè®¾ç½®å·¥ä½œç›®å½•
)
```

5. **ä¼ é€’ç›¸å¯¹æ–‡ä»¶å**:
```python
# Python
file_names = [f['name'] for f in workspace_files]
cmd.extend(['--files', json.dumps(file_names)])

# JavaScript
file_names = [f['name'] for f in workspace_files]
env['PARAM_FILES'] = json.dumps(file_names)
```

## ç¤ºä¾‹è„šæœ¬ ğŸ“

### å·¥ä½œç›®å½•æ¼”ç¤ºè„šæœ¬

**ä½ç½®**: `example_scripts/workspace_demo.py`

**åŠŸèƒ½**:
- æ˜¾ç¤ºå½“å‰å·¥ä½œç›®å½•
- åˆ—å‡ºå·¥ä½œç›®å½•å†…å®¹
- å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
- åˆ›å»ºæ–°æ–‡ä»¶
- æ¼”ç¤ºå„ç§æ–‡ä»¶æ“ä½œ

**ä½¿ç”¨æ–¹æ³•**:
1. åœ¨ç³»ç»Ÿä¸­åˆ›å»ºæ–°è„šæœ¬
2. å¤åˆ¶ `workspace_demo.py` çš„å†…å®¹
3. ä¸Šä¼ ä¸€äº›æµ‹è¯•æ–‡ä»¶
4. æ‰§è¡Œå¹¶æŸ¥çœ‹å®æ—¶æ—¥å¿—

**è¾“å‡ºç¤ºä¾‹**:
```
======================================================================
  ğŸ“ å·¥ä½œç›®å½•ä¿¡æ¯
======================================================================
å½“å‰å·¥ä½œç›®å½•: /path/to/workspaces/script_5
ç»å¯¹è·¯å¾„:     /path/to/workspaces/script_5
çˆ¶ç›®å½•:       /path/to/workspaces

ğŸ“‹ å·¥ä½œç›®å½•å†…å®¹:
  [1] ğŸ“„ test.txt (1234 å­—èŠ‚)
  [2] ğŸ“„ script_123.py (567 å­—èŠ‚)

======================================================================
  ğŸ“¤ å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
======================================================================
æ¥æ”¶åˆ° 1 ä¸ªæ–‡ä»¶:

[1] ğŸ“„ test.txt
    å¤§å°: 1234 å­—èŠ‚
    å†…å®¹é¢„è§ˆ (å‰3è¡Œ):
      ç¬¬ä¸€è¡Œå†…å®¹
      ç¬¬äºŒè¡Œå†…å®¹
      ç¬¬ä¸‰è¡Œå†…å®¹
```

## å®‰å…¨è€ƒè™‘ ğŸ”’

### é™åˆ¶

1. **è·¯å¾„éå†é˜²æŠ¤**: è„šæœ¬æ— æ³•ä½¿ç”¨ `../` è®¿é—®çˆ¶ç›®å½•
2. **ç»å¯¹è·¯å¾„é™åˆ¶**: è„šæœ¬åªèƒ½ä½¿ç”¨ç›¸å¯¹è·¯å¾„
3. **ç›®å½•éš”ç¦»**: æ¯ä¸ªè„šæœ¬åªèƒ½è®¿é—®è‡ªå·±çš„å·¥ä½œç›®å½•
4. **æƒé™æ§åˆ¶**: å·¥ä½œç›®å½•æƒé™é™åˆ¶ä¸ºè„šæœ¬ç”¨æˆ·

### æœ€ä½³å®è·µ

**è„šæœ¬ç¼–å†™å»ºè®®**:
```python
# âœ… æ¨èï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„
with open("data.txt", 'r') as f:
    content = f.read()

# âœ… æ¨èï¼šåœ¨å½“å‰ç›®å½•åˆ›å»ºæ–‡ä»¶
with open("output.txt", 'w') as f:
    f.write("result")

# âŒ é¿å…ï¼šä½¿ç”¨ç»å¯¹è·¯å¾„
with open("/tmp/data.txt", 'r') as f:  # å¯èƒ½å¤±è´¥
    content = f.read()

# âŒ é¿å…ï¼šè®¿é—®çˆ¶ç›®å½•
with open("../other_script/file.txt", 'r') as f:  # ä¸æ¨è
    content = f.read()
```

## ç»´æŠ¤ç®¡ç† ğŸ› ï¸

### æ¸…ç†å·¥ä½œç›®å½•

å¯ä»¥æ‰‹åŠ¨æ¸…ç†ä¸éœ€è¦çš„å·¥ä½œç›®å½•ï¼š

```bash
# æ¸…ç†æ‰€æœ‰å·¥ä½œç›®å½•
rm -rf workspaces/*/

# æ¸…ç†ç‰¹å®šè„šæœ¬çš„å·¥ä½œç›®å½•
rm -rf workspaces/script_5/

# åªæ¸…ç†è„šæœ¬æ‰§è¡Œæ–‡ä»¶ï¼Œä¿ç•™å…¶ä»–æ–‡ä»¶
find workspaces/ -name "script_*.py" -delete
```

### ç£ç›˜ç©ºé—´ç›‘æ§

```bash
# æŸ¥çœ‹å·¥ä½œç›®å½•æ€»å¤§å°
du -sh workspaces/

# æŸ¥çœ‹æ¯ä¸ªè„šæœ¬çš„å·¥ä½œç›®å½•å¤§å°
du -sh workspaces/*/

# æŸ¥çœ‹æœ€å¤§çš„å·¥ä½œç›®å½•
du -sh workspaces/*/ | sort -hr | head -10
```

## æ•…éšœæ’é™¤ ğŸ”§

**é—®é¢˜1: è„šæœ¬æ‰¾ä¸åˆ°æ–‡ä»¶**
- ç¡®è®¤æ–‡ä»¶å·²ä¸Šä¼ 
- ä½¿ç”¨ç›¸å¯¹æ–‡ä»¶åè€Œéç»å¯¹è·¯å¾„
- æ£€æŸ¥å·¥ä½œç›®å½•å†…å®¹: `os.listdir('.')`

**é—®é¢˜2: æ— æ³•åˆ›å»ºæ–‡ä»¶**
- æ£€æŸ¥å·¥ä½œç›®å½•æ˜¯å¦å­˜åœ¨
- ç¡®è®¤ç›®å½•æƒé™
- æŸ¥çœ‹é”™è¯¯æ—¥å¿—

**é—®é¢˜3: æ–‡ä»¶æƒé™é—®é¢˜**
- ç¡®ä¿è„šæœ¬åœ¨æ­£ç¡®çš„å·¥ä½œç›®å½•æ‰§è¡Œ
- æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿæƒé™è®¾ç½®

## æœªæ¥å¢å¼º ğŸš€

- [ ] å·¥ä½œç›®å½•å¤§å°é™é¢
- [ ] è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ–‡ä»¶
- [ ] å·¥ä½œç›®å½•å¿«ç…§å’Œæ¢å¤
- [ ] å·¥ä½œç›®å½•æµè§ˆç•Œé¢
- [ ] æ–‡ä»¶ä¸‹è½½åŠŸèƒ½
- [ ] å·¥ä½œç›®å½•ç»Ÿè®¡ä¿¡æ¯

## ç›¸å…³æ–‡ä»¶

- é…ç½®: `backend/config.py`
- è„šæœ¬API: `backend/api/scripts.py`
- æ‰§è¡Œå¼•æ“: `backend/services/executor.py`
- ç¤ºä¾‹è„šæœ¬: `example_scripts/workspace_demo.py`
